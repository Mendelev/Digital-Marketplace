template:
  name: Generate_Maven_Settings
  type: Step
  orgIdentifier: default
  spec:
    type: Run
    spec:
      connectorRef: account.Dockerhub
      image: maven:3.9-eclipse-temurin-21
      shell: Sh
      command: |-
        mkdir -p ~/.m2

        # Generate settings.xml with JFrog credentials and deployment repository
        cat > ~/.m2/settings.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <settings xmlns="http://maven.apache.org/SETTINGS/1.2.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.2.0 https://maven.apache.org/xsd/settings-1.2.0.xsd">
          
          <!-- Authentication for JFrog Artifactory -->
          <servers>
            <server>
              <id>snapshots</id>
              <username><+secrets.getValue("account.jfrog_username")></username>
              <password><+secrets.getValue("account.jfrog_token")></password>
            </server>
            <server>
              <id>jfrog-releases</id>
              <username><+secrets.getValue("account.jfrog_username")></username>
              <password><+secrets.getValue("account.jfrog_token")></password>
            </server>
          </servers>
          
          <!-- Active profile for deployment configuration -->
          <profiles>
            <profile>
              <id>artifactory-deploy</id>
              <activation>
                <activeByDefault>true</activeByDefault>
              </activation>
              <properties>
                <altDeploymentRepository>snapshots::default::<+pipeline.variables.jfrogBaseUrl>/<+pipeline.variables.jfrogRepoName></altDeploymentRepository>
              </properties>
              <repositories>
                <repository>
                  <id>jfrog-releases</id>
                  <url><+pipeline.variables.jfrogBaseUrl>/libs-release-local</url>
                  <releases>
                    <enabled>true</enabled>
                  </releases>
                  <snapshots>
                    <enabled>false</enabled>
                  </snapshots>
                </repository>
                <repository>
                  <id>jfrog-snapshots</id>
                  <url><+pipeline.variables.jfrogBaseUrl>/libs-snapshot-local</url>
                  <releases>
                    <enabled>false</enabled>
                  </releases>
                  <snapshots>
                    <enabled>true</enabled>
                  </snapshots>
                </repository>
              </repositories>
            </profile>
          </profiles>
        </settings>
        EOF

        echo "Maven settings.xml generated successfully"
        echo "=========================================="
        echo "Service: <+pipeline.variables.serviceName>"
        echo "Target repository: <+pipeline.variables.jfrogBaseUrl>/<+pipeline.variables.jfrogRepoName>"
        echo "Version: 1.0.0-<+pipeline.sequenceId>"
        echo "========================================="
  identifier: Generate_Maven_Settings
  versionLabel: version1
